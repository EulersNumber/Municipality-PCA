---
title: "PCA on Finnish Municipalities"
author: "Niko Miller"
date: "`r format(Sys.time(), '%d.%m.%Y')`"
output: 
  pdf_document:
    keep_tex: false
    number_sections: true
    fig_caption: true
    citation_package: natbib
bibliography: references.bib
header-includes:
- \pagenumbering{gobble}
- \usepackage{amsmath}
- \usepackage{amssymb}
- \usepackage{amsfonts}
- \usepackage{mathtools}
- \usepackage{graphicx}
- \usepackage{placeins}
- \usepackage{float}
- \floatplacement{figure}{H}
- \usepackage{framed}
- \usepackage[font={small,it}]{caption}
- \usepackage[font={small,it}]{subcaption}
- \usepackage{hyperref}
- \usepackage[labelsep=period]{caption}
- \usepackage[labelfont=bf]{caption}
- \captionsetup{justification=raggedright,singlelinecheck=false}

subtitle: "Dimensionality reduction with PCA on Finnish municipality demographics"
geometry: top=0.7in, bottom=0.5in, left=0.5in, right=0.7in
---

```{r setup, include=FALSE}

knitr::opts_chunk$set(echo = TRUE)
knitr::knit_hooks$set(optipng = knitr::hook_optipng)
options(ggrepel.max.overlaps = Inf)

library(tidyverse)
library(knitr)
library(kableExtra)
library(summarytools)
library(pxweb)
library(ggplot2)
library(reshape2)
library(ggcorrplot)
library(ggrepel)
library(ggfortify)

# muni.latest <- read.csv("muni.csv")
# muni.latest <- muni.latest[, -1] %>% as_tibble()

muni.latest <- read.csv("muni_2021.csv", sep = ";" , header = F)
colnames(muni.latest) <- c('Area', 'Prop.Urban.Areas', 'Pop', 'Pop.Change', 'Prop.Below15', 'Prop.15to64', 'Prop.Over64', 'Prop.Swedish', 'Prop.Foreign', 'Pop.Growth', 'Migr.Gain', 'Families', 'Households', 'Prop.Households.rowSmall', 'Prop.Households.Rent', 'Prop.Educ.Degree2', 'Prop.Educ.High', 'Employed', 'Empl.Rate', 'Prop.Households.Empl', 'Prop.Unempl', 'Prop.Pension', 'Support.Ratio', 'Jobs', 'Prop.Primary.Sector', 'Prop.Secondary.Sector', 'Prop.Services.Sector', 'Jobs.Self.Suff', 'Margin.Citizen', 'Loan.Citizen', 'Concern.Loan.Citizen', 'Educ.Cult.Citizen', 'Soc.Health.Citizen')

muni.latest <- muni.latest %>% filter(!grepl('koko maa|maakunta|seutukunta|mariehamn', Area, ignore.case = T))

muni.latest <- muni.latest %>% 
  arrange(desc(Pop))

```

<!-- \vspace{-1cm} -->

\tableofcontents

<!-- \listoftables -->
<!-- \listoffigures -->

\newpage
\pagenumbering{arabic}

# Introduction

## Data and Research Questions

Tilastokeskus provides data on 32 demographic variables of Finnish municipalities. The data can be freely obtained from Tilastokeskus' website in csv. format [@data]. 

The variables provide information on e.g., the municipalities' population and its growth, age structure, economic sector structure, and the split between different housing types.

The purpose of this study is to reduce dimensionality in the data and assess whether differences between the municipalities can be explained by considerably less than 32 dimensions - namely by first few principal components (PCs). This study's contribution can be seen as exploratory data analysis where the municipalities are clustered in a lower dimension. The results can be applied in further work in e.g., more advanced clustering, prediction or economic decision making. 

Clustering municipalities with demographic factors can be useful in a business context, e.g., marketing. Knowing how municipalities differ in demographics can help a company to improve its targeting and e.g., launch different marketing campaigns or product lines in different municipalities.

# Univariate Analysis

## Variable Descriptions

```{r, echo=FALSE}

vars.orig <- c('Taajama-aste, %', 'Väkiluku', 'Väkiluvun muutos edellisestä vuodesta, %', 'Alle 15-vuotiaiden osuus väestöstä, %', '15-64 -vuotiaiden osuus väestöstä, %', 'Yli 64-vuotiaiden osuus väestöstä, %', 'Ruotsinkielisten osuus väestöstä, %', 'Ulkomaan kansalaisten osuus väestöstä, %', 'Syntyneiden enemmyys, henkilöä', 'Kuntien välinen muuttovoitto/-tappio, henkilöä', 'Perheiden lukumäärä', 'Asuntokuntien lukumäärä', 'Rivi- ja pientaloissa asuvien asuntokuntien osuus, %', 'Vuokra-asunnoissa asuvien asuntokuntien osuus, %', 'Vähintään toisen asteen tutkinnon suorittaneiden osuus 15 vuotta täyttäneistä, %', 'Korkea-asteen tutkinnon suorittaneiden osuus 15 vuotta täyttäneistä, %', 'Alueella asuvan työllisen työvoiman määrä', 'Työllisyysaste, %', 'Asuinkunnassaan työssäkäyvien osuus, %', 'Työttömien osuus työvoimasta, %', 'Eläkeläisten osuus väestöstä, %', 'Taloudellinen huoltosuhde', 'Alueella olevien työpaikkojen lukumäärä', 'Alkutuotannon työpaikkojen osuus, %', 'Jalostuksen työpaikkojen osuus, %', 'Palvelujen työpaikkojen osuus, %', 'Työpaikkaomavaraisuus', 'Vuosikate, euroa/asukas', 'Lainakanta, euroa/asukas', 'Konsernin lainakanta, euroa/asukas', 'Opetus- ja kulttuuritoiminta yhteensä, nettokäyttökustannukset, euroa/asukas', 'Sosiaali- ja terveystoiminta yhteensä, nettokäyttökustannukset, euroa/asukas')
               
vars <-  c('Prop.Urban.Areas', 'Pop', 'Pop.Change', 'Prop.Below15', 'Prop.15to64', 'Prop.Over64', 'Prop.Swedish', 'Prop.Foreign', 'Pop.Growth', 'Migr.Gain', 'Families', 'Households', 'Prop.Households.rowSmall', 'Prop.Households.Rent', 'Prop.Educ.Degree2', 'Prop.Educ.High', 'Employed', 'Empl.Rate', 'Prop.Households.Empl', 'Prop.Unempl', 'Prop.Pension', 'Support.Ratio', 'Jobs', 'Prop.Primary.Sector', 'Prop.Secondary.Sector', 'Prop.Services.Sector', 'Jobs.Self.Suff', 'Margin.Citizen', 'Loan.Citizen', 'Concern.Loan.Citizen', 'Educ.Cult.Citizen', 'Soc.Health.Citizen')

explanations <- rep("NA", length(vars))

var.df <- data.frame(vars.orig, vars, explanations)

kable(var.df, format = "latex", align = "lll", col.names = c("Original", "Modified", "Explanation"), caption = "Variable Descriptions") %>%
  row_spec(0, bold = T) %>% 
  kable_styling(latex_options = c("HOLD_position", "scale_down"), position = "left")

```


## Descriptive Statistics

```{r, echo=FALSE}
stats <- muni.latest[, -1] %>% apply(2, summary) %>% t() %>% as.data.frame()
stats$Std <- muni.latest[, -1] %>% apply(2, sd)

stats.df <- data.frame(vars, stats)
rownames(stats.df) <- NULL

kable(stats.df, format = "latex", align = "lrrrrrr", caption = "Descriptive Statistics", digits = 1, col.names = c("Var", "Min", "1st Qu.", "Median", "Mean", "3rd Qu.", "Max", "Std.")) %>% 
  row_spec(0, bold = T) %>% 
  kable_styling(latex_options = "HOLD_position", position = "left")

```


## Distribution Plots

```{r, include=FALSE}

ages <- muni.latest %>% 
  select(Prop.Below15, Prop.15to64, Prop.Over64)
ages <- melt(ages)

living <- muni.latest %>% 
  select(Prop.Households.rowSmall, Prop.Households.Rent)
living <- melt(living)

employment <- muni.latest %>% 
  select(Empl.Rate, Prop.Unempl, Prop.Pension)
employment <- melt(employment)

sectors <- muni.latest %>% 
  select(Prop.Primary.Sector, Prop.Secondary.Sector, Prop.Services.Sector)
sectors <- melt(sectors)

```


```{r, echo=FALSE, fig.cap='Probability density estimates for age groups', position, out.width='80%'}

ggplot(ages, aes(x=value, fill=variable)) + geom_density(alpha = .25, adjust = .75) + theme_minimal() +
  scale_fill_manual( values = c("#dde318","#3dbc74","#440154")) +
  labs(x = "Percentage (%) of Population", y = "Density", fill = "Variable", title = "Age Groups") +
  theme(legend.position = "right", legend.text = element_text(size = 9))

```


```{r, echo=FALSE, fig.cap='Probability density estimates for living types', out.width='80%'}

ggplot(living, aes(x=value, fill=variable)) + geom_density(alpha = .25, adjust = .75) + theme_minimal() +
  scale_fill_manual( values = c("#dde318","#3dbc74","#440154")) +
  labs(x = "Percentage (%) of Population", y = "Density", fill = "Variable", title = "Living Types") +
  theme(legend.position = "right", legend.text = element_text(size = 9))

```


```{r, echo=FALSE, fig.cap='Probability density estimates for employment groups', out.width='80%'}

ggplot(employment, aes(x=value, fill=variable)) + geom_density(alpha = .25, adjust = .75) + theme_minimal() +
  scale_fill_manual( values = c("#dde318","#3dbc74","#440154")) +
  labs(x = "Percentage (%) of Population", y = "Density", fill = "Variable", title = "Employment Groups") +
  theme(legend.position = "right", legend.text = element_text(size = 9))

```


```{r, echo=FALSE, fig.cap='Probability density estimates for economic sectors', out.width='80%'}

ggplot(living, aes(x=value, fill=variable)) + geom_density(alpha = .25, adjust = .75) + theme_minimal() +
  scale_fill_manual( values = c("#dde318","#3dbc74","#440154")) +
  labs(x = "Percentage (%) of Population", y = "Density", fill = "Variable", title = "Economic Sectors") +
  theme(legend.position = "right", legend.text = element_text(size = 9))

```

# Bivariate Analysis

## Linear Dependencies

```{r, echo=FALSE, fig.dim=c(18,18), fig.cap="Heatmap of Pearson'n correlation between all variables", optipng = '-o7'}
corr <- cor(muni.latest[, -1])
ggcorrplot(corr, hc.order = TRUE, type = "full", lab = TRUE, title = "Heatmap of Correlations", lab_size = 3.5)

```

# Principal Component Analysis (PCA)

## Scree Plot

```{r, echo=FALSE, fig.cap="Variance explained by each Princial Component (PC) up to the 20th PC. This type of a plot is also known as a Scree Plot", optipng = '-o7'}

muni.latest.pca <- muni.latest %>% column_to_rownames(var = "Area")
muni.pca <- prcomp(muni.latest.pca, center = T, scale. = T)

muni.pca.summary <- summary(muni.pca)
scree.df <- muni.pca.summary$importance[, 1:20] %>% t() %>% as.data.frame()
scree.df$PC <- 1:20
scree.df$Included <- c(rep("Yes",4), rep("No",16))
scree.df <- scree.df[, c(4,2,3,5)]
rownames(scree.df) <- NULL
colnames(scree.df) <- c("PC", "Prop.var", "Cum.prop", "Included")

ggplot(scree.df) +
  geom_bar(aes(x = PC, y = Prop.var, fill = Included), stat = "identity") +
  scale_fill_manual(values = c("#440154", "#3dbc74")) +
  geom_line(aes(x = PC, y = Cum.prop)) +
  geom_point(aes(x = PC, y = Cum.prop)) +
  geom_hline(yintercept = 0.75, linetype = 2) +
  annotate("text", x=10.5, y=0.78, label= "75% of variance explained", size = 3) +
  labs(x = "Principal Component", y = "Variance Explained (%)", title = "PCA Scree Plot") +
  guides(fill = guide_legend(reverse = TRUE)) +
  theme_minimal()

```

## Principal Components 1 and 2

```{r, echo=FALSE, message=FALSE, fig.cap="Score plot for all municipalities that have a top 5 absolute loading in any of PC1 and PC2", fig.align='center'}

loads <- muni.pca$x[, 1:2] %>% as.data.frame() %>% rownames_to_column() %>% as_tibble() %>% dplyr::rename(Area = rowname)

greatest5.PC1 <- loads %>% 
  arrange(desc(PC1)) %>% 
  head(5)

smallest5.PC1 <- loads %>% 
  arrange(PC1) %>% 
  head(5)

greatest5.PC2 <- loads %>% 
  arrange(desc(PC2)) %>% 
  head(5)

smallest5.PC2 <- loads %>% 
  arrange(PC2) %>% 
  head(5)

loads.reduced <- full_join(greatest5.PC1, smallest5.PC1) %>% full_join(greatest5.PC2) %>% full_join(smallest5.PC2)

ggplot(loads.reduced, aes(x = PC1, y = PC2, label = Area)) +
  geom_point() +
  geom_text_repel(size = 3) +
  xlim(c(-25,10)) +
  ylim(c(-20,15)) +
  theme_minimal() +
  ggtitle("PCA Scores")

```


```{r, warning=FALSE, echo=FALSE, fig.cap="Loading directions for PC1 and PC2", fig.align='center'}

ggplot2::autoplot(muni.pca, 
                  alpha = 0,
                  loadings = T, 
                  loadings.colour = "black", 
                  loadings.label = T, 
                  loadings.label.colour = "red",
                  loadings.label.size = 2.5, 
                  loadings.label.repel = T) +
  scale_x_continuous(limits = c(-0.4, 0.4)) +
  scale_y_continuous(limits = c(-0.4, 0.4)) +
  theme_minimal() +
  labs(x = "Standardized PC1 (33.6% explained var.)",
       y = "Standardized PC1 (20.9% explained var.)",
       title = "PCA Loadings")

```

## Principal Components 3 and 4


```{r, echo=FALSE, message=FALSE, fig.cap="Score plot for all municipalities that have a top 5 absolute loading in any of PC3 and PC4", fig.align='center'}

loads <- muni.pca$x[, 3:4] %>% as.data.frame() %>% rownames_to_column() %>% as_tibble() %>% dplyr::rename(Area = rowname)

greatest5.PC3 <- loads %>% 
  arrange(desc(PC3)) %>% 
  head(5)

smallest5.PC3 <- loads %>% 
  arrange(PC3) %>% 
  head(5)

greatest5.PC4 <- loads %>% 
  arrange(desc(PC4)) %>% 
  head(5)

smallest5.PC4 <- loads %>% 
  arrange(PC4) %>% 
  head(5)

loads.reduced <- full_join(greatest5.PC3, smallest5.PC3) %>% full_join(greatest5.PC4) %>% full_join(smallest5.PC4)

ggplot(loads.reduced, aes(x = PC3, y = PC4, label = Area)) +
  geom_point() +
  geom_text_repel(size = 3) +
  xlim(c(-5,5)) +
  ylim(c(-8,8)) +
  theme_minimal() +
  ggtitle("PCA Scores")

```


```{r, warning=FALSE, echo=FALSE, fig.cap="Loading directions for PC3 and PC4", fig.align='center'}

ggplot2::autoplot(muni.pca,
                  x = 3,
                  y = 4,
                  alpha = 0,
                  loadings = T, 
                  loadings.colour = "black", 
                  loadings.label = T, 
                  loadings.label.colour = "red",
                  loadings.label.size = 2.5, 
                  loadings.label.repel = T) +
  scale_x_continuous(limits = c(-0.3, 0.3)) +
  scale_y_continuous(limits = c(-0.3, 0.3)) +
  theme_minimal() +
  labs(x = "Standardized PC3 (10.2% explained var.)",
       y = "Standardized PC4 (7.2% explained var.)",
       title = "PCA Loadings")

```

# Discussion and Conclusions

- PC1 and PC2 do not explain a high percentage of the variance (above 80%). Hence, PCA might not be so well suited
- Using population, employed persons and some other absolute measures might have alienated Helsinki from the other cities and biased the analysis a bit. Perhaps leaving out Helsinki would have been a wise choice
- Highly correlated variables could have been reduced to only one, i.e., remove unnecessary variables
- Something else?

\newpage
# References



