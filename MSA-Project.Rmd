---
title: "PCA on Finnish Municipalities"
author: "Niko Miller"
date: "`r format(Sys.time(), '%d.%m.%Y')`"
output: 
  pdf_document:
    keep_tex: false
    number_sections: true
    fig_caption: true
    citation_package: natbib
    # extra_dependencies: ["float"]
bibliography: references.bib
header-includes:
- \pagenumbering{gobble}
- \usepackage{amsmath}
- \usepackage{amssymb}
- \usepackage{amsfonts}
- \usepackage{mathtools}
- \usepackage{graphicx}
- \usepackage{placeins}
- \usepackage{float}
- \floatplacement{figure}{H}
- \usepackage{framed}
- \usepackage[font={small,it}]{caption}
- \usepackage[font={small,it}]{subcaption}
- \usepackage{hyperref}
- \usepackage[labelsep=period]{caption}
- \usepackage[labelfont=bf]{caption}
- \captionsetup{justification=raggedright,singlelinecheck=false}

subtitle: "Dimensionality reduction with PCA on Finnish municipality demographics"
geometry: top=0.7in, bottom=0.5in, left=0.5in, right=0.7in
---

```{r setup, include=FALSE}

knitr::opts_chunk$set(echo = TRUE)
knitr::knit_hooks$set(optipng = knitr::hook_optipng)
library(tidyverse)
library(knitr)
library(kableExtra)
library(summarytools)
library(pxweb)
library(ggplot2)
library(reshape2)
library(ggcorrplot)

```

<!-- \vspace{-1cm} -->

\tableofcontents

<!-- \listoftables -->
<!-- \listoffigures -->

\newpage
\pagenumbering{arabic}

# Introduction

## Motivation

Tilastokeskus provides data on 32 demographic variables of Finnish municipalities [@data]. Those variables are in many cases correlated and some are perhaps better in explaining differences between municipalities. Hence, an interesting question is whether we could reduce dimensionality of the data and describe municipalities using only a few variables.

## Objective and research question

## Scope

# Data and Exploratory Analysis

I used PXWEB API [@pxweb] to retrieve a data set on key ratios for all of Finland's municipalities during 1987-2019 according to the 2020 municipality classification. The data set is provided by Tilastokeskus [@data].

```{r, include=FALSE}

muni.latest <- read.csv("muni.csv")
muni.latest <- muni.latest[, -1] %>% as_tibble()

```

## Variable Descriptions

```{r, echo=FALSE}

vars.orig <- c('Taajama-aste, %', 'Väkiluku', 'Väkiluvun muutos edellisestä vuodesta, %', 'Alle 15-vuotiaiden osuus väestöstä, %', '15-64 -vuotiaiden osuus väestöstä, %', 'Yli 64-vuotiaiden osuus väestöstä, %', 'Ruotsinkielisten osuus väestöstä, %', 'Ulkomaan kansalaisten osuus väestöstä, %', 'Syntyneiden enemmyys, henkilöä', 'Kuntien välinen muuttovoitto/-tappio, henkilöä', 'Perheiden lukumäärä', 'Asuntokuntien lukumäärä', 'Rivi- ja pientaloissa asuvien asuntokuntien osuus, %', 'Vuokra-asunnoissa asuvien asuntokuntien osuus, %', 'Vähintään toisen asteen tutkinnon suorittaneiden osuus 15 vuotta täyttäneistä, %', 'Korkea-asteen tutkinnon suorittaneiden osuus 15 vuotta täyttäneistä, %', 'Alueella asuvan työllisen työvoiman määrä', 'Työllisyysaste, %', 'Asuinkunnassaan työssäkäyvien osuus, %', 'Työttömien osuus työvoimasta, %', 'Eläkeläisten osuus väestöstä, %', 'Taloudellinen huoltosuhde', 'Alueella olevien työpaikkojen lukumäärä', 'Alkutuotannon työpaikkojen osuus, %', 'Jalostuksen työpaikkojen osuus, %', 'Palvelujen työpaikkojen osuus, %', 'Työpaikkaomavaraisuus', 'Vuosikate, euroa/asukas', 'Lainakanta, euroa/asukas', 'Konsernin lainakanta, euroa/asukas', 'Opetus- ja kulttuuritoiminta yhteensä, nettokäyttökustannukset, euroa/asukas', 'Sosiaali- ja terveystoiminta yhteensä, nettokäyttökustannukset, euroa/asukas')
               
vars <-  c('Prop.Urban.Areas', 'Pop', 'Pop.Change', 'Prop.Below15', 'Prop.15to64', 'Prop.Over64', 'Prop.Swedish', 'Prop.Foreign', 'Pop.Growth', 'Migr.Gain', 'Families', 'Households', 'Prop.Households.rowSmall', 'Prop.Households.Rent', 'Prop.Educ.Degree2', 'Prop.Educ.High', 'Employed', 'Empl.Rate', 'Prop.Households.Empl', 'Prop.Unempl', 'Prop.Pension', 'Support.Ratio', 'Jobs', 'Prop.Primary.Sector', 'Prop.Secondary.Sector', 'Prop.Services.Sector', 'Jobs.Self.Suff', 'Margin.Citizen', 'Loan.Citizen', 'Concern.Loan.Citizen', 'Educ.Cult.Citizen', 'Soc.Health.Citizen')

explanations <- rep("NA", length(vars))

var.df <- data.frame(vars.orig, vars, explanations)

kable(var.df, format = "latex", align = "lll", col.names = c("Original", "Modified", "Explanation"), caption = "Variable Descriptions") %>%
  row_spec(0, bold = T) %>% 
  kable_styling(latex_options = c("HOLD_position", "scale_down"), position = "left")

```

## Univariate Analysis

### Descriptive Statistics

```{r, echo=FALSE}
stats <- muni.latest[, -1] %>% apply(2, summary) %>% t() %>% as.data.frame()
stats$Std <- muni.latest[, -1] %>% apply(2, sd)

stats.df <- data.frame(vars, stats)
rownames(stats.df) <- NULL

kable(stats.df, format = "latex", align = "lrrrrrr", caption = "Descriptive Statistics", digits = 1, col.names = c("Var", "Min", "1st Qu.", "Median", "Mean", "3rd Qu.", "Max", "Std.")) %>% 
  row_spec(0, bold = T) %>% 
  kable_styling(latex_options = "HOLD_position", position = "left")

```


### Distribution Plots

```{r, include=FALSE}

ages <- muni.latest %>% 
  select(Prop.Below15, Prop.15to64, Prop.Over64)
ages <- melt(ages)

living <- muni.latest %>% 
  select(Prop.Households.rowSmall, Prop.Households.Rent)
living <- melt(living)

employment <- muni.latest %>% 
  select(Empl.Rate, Prop.Unempl, Prop.Pension)
employment <- melt(employment)

sectors <- muni.latest %>% 
  select(Prop.Primary.Sector, Prop.Secondary.Sector, Prop.Services.Sector)
sectors <- melt(sectors)

```


```{r, echo=FALSE, fig.cap='Probability density estimates for age groups', position, out.width='80%'}

ggplot(ages, aes(x=value, fill=variable)) + geom_density(alpha = .25, adjust = .75) + theme_minimal() +
  scale_fill_manual( values = c("#dde318","#3dbc74","#440154")) +
  labs(x = "Percentage (%) of Population", y = "Density", fill = "Variable", title = "Age Groups") +
  theme(legend.position = "right", legend.text = element_text(size = 9))

```


```{r, echo=FALSE, fig.cap='Probability density estimates for living types', out.width='80%'}

ggplot(living, aes(x=value, fill=variable)) + geom_density(alpha = .25, adjust = .75) + theme_minimal() +
  scale_fill_manual( values = c("#dde318","#3dbc74","#440154")) +
  labs(x = "Percentage (%) of Population", y = "Density", fill = "Variable", title = "Living Types") +
  theme(legend.position = "right", legend.text = element_text(size = 9))

```


```{r, echo=FALSE, fig.cap='Probability density estimates for employment groups', out.width='80%'}

ggplot(employment, aes(x=value, fill=variable)) + geom_density(alpha = .25, adjust = .75) + theme_minimal() +
  scale_fill_manual( values = c("#dde318","#3dbc74","#440154")) +
  labs(x = "Percentage (%) of Population", y = "Density", fill = "Variable", title = "Employment Groups") +
  theme(legend.position = "right", legend.text = element_text(size = 9))

```


```{r, echo=FALSE, fig.cap='Probability density estimates for economic sectors', out.width='80%'}

ggplot(living, aes(x=value, fill=variable)) + geom_density(alpha = .25, adjust = .75) + theme_minimal() +
  scale_fill_manual( values = c("#dde318","#3dbc74","#440154")) +
  labs(x = "Percentage (%) of Population", y = "Density", fill = "Variable", title = "Economic Sectors") +
  theme(legend.position = "right", legend.text = element_text(size = 9))

```

## Bivariate Analysis

### Pearson's Correlation

```{r, echo=FALSE, fig.dim=c(18,18), fig.cap="Heatmap of Pearson'n correlation between all variables", optipng = '-o7'}
corr <- cor(muni.latest[, -1])
ggcorrplot(corr, hc.order = TRUE, type = "full", lab = TRUE, title = "Heatmap of Correlations", lab_size = 3.5)

```

# Principal Component Analysis (PCA)

## Scree Plot

```{r, echo=FALSE, fig.cap="Variance explained by each Princial Component. This type of a plot is also known as a Scree Plot", optipng = '-o7'}

muni.latest.pca <- muni.latest %>% column_to_rownames(var = "Area")
muni.pca <- prcomp(muni.latest.pca, scale. = T)

muni.pca.summary <- summary(muni.pca)
scree.df <- muni.pca.summary$importance[, 1:20] %>% t() %>% as.data.frame()
scree.df$PC <- 1:20
scree.df$Included <- c(rep("Yes",4), rep("No",16))
scree.df <- scree.df[, c(4,2,3,5)]
rownames(scree.df) <- NULL
colnames(scree.df) <- c("PC", "Prop.var", "Cum.prop", "Included")

ggplot(scree.df) +
  geom_bar(aes(x = PC, y = Prop.var, fill = Included), stat = "identity") +
  scale_fill_manual(values = c("#440154", "#3dbc74")) +
  geom_line(aes(x = PC, y = Cum.prop)) +
  geom_point(aes(x = PC, y = Cum.prop)) +
  geom_hline(yintercept = 0.75, linetype = 2) +
  annotate("text", x=10.5, y=0.78, label= "75% of variance explained", size = 3) +
  labs(x = "Principal Component", y = "Variance Explained (%)", title = "PCA Scree Plot") +
  guides(fill = guide_legend(reverse = TRUE)) +
  theme_minimal()

```

## Biplot

## Principal Components 1 and 2

## Principal Components 3 and 4

# Discussion and Conclusions


\newpage
# References



